name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  CARGO_TERM_COLOR: always
  RUSTC_BOOTSTRAP: 1

jobs:
  fmt:
    name: Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxi-dev \
            libasound2-dev \
            libudev-dev \
            libvulkan-dev
      - run: cargo clippy --workspace --all-targets -- -D warnings

  test-core:
    name: Test Core Crates (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxcursor-dev libxrandr-dev libxi-dev \
            libasound2-dev libudev-dev libvulkan-dev
      - name: Test ferrum-core
        run: cargo test --package ferrum-core
      - name: Test ferrum-physics
        run: cargo test --package ferrum-physics
      - name: Test ferrum-world
        run: cargo test --package ferrum-world
      - name: Test ferrum-inventory
        run: cargo test --package ferrum-inventory
      - name: Test ferrum-config
        run: cargo test --package ferrum-config

  test-rendering:
    name: Test Rendering & Meshing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxcursor-dev libxrandr-dev libxi-dev \
            libasound2-dev libudev-dev libvulkan-dev
      - name: Test ferrum-meshing-cpu
        run: cargo test --package ferrum-meshing-cpu
      - name: Test ferrum-render
        run: cargo test --package ferrum-render
      - name: Test ferrum-entity
        run: cargo test --package ferrum-entity

  test-network:
    name: Test Networking & Assets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxcursor-dev libxrandr-dev libxi-dev \
            libasound2-dev libudev-dev libvulkan-dev
      - name: Test ferrum-protocol
        run: cargo test --package ferrum-protocol
      - name: Test ferrum-assets
        run: cargo test --package ferrum-assets
